import jsPDF from 'jspdf';
import 'jspdf-autotable';

// Helper to format missing data
const safe = (value) => value ?? '—';

const downloadPDF = (user) => {
  const doc = new jsPDF();
  doc.setFontSize(18);
  doc.text(`MindMirror3D — Personality Report`, 14, 18);

  // User info
  doc.setFontSize(12);
  doc.text(`Email: ${safe(user.email)}`, 14, 28);
  if (user.full_name) {
    doc.text(`Name: ${user.full_name}`, 14, 34);
  }

  let currentY = 42;

  // ------------------------------
  // BIG FIVE TABLE
  // ------------------------------

  doc.setFontSize(14);
  doc.text(`Big Five Personality Scores`, 14, currentY);
  currentY += 6;

  const bigFiveTable = [
    ['Openness', safe(user.openness)],
    ['Conscientiousness', safe(user.conscientiousness)],
    ['Extraversion', safe(user.extraversion)],
    ['Agreeableness', safe(user.agreeableness)],
    ['Neuroticism', safe(user.neuroticism)],
  ];

  doc.autoTable({
    startY: currentY,
    head: [['Trait', 'Score']],
    body: bigFiveTable,
    margin: { left: 14, right: 14 },
  });

  currentY = doc.lastAutoTable.finalY + 12;

  // ------------------------------
  // BASIC NEEDS TABLE
  // ------------------------------

  doc.setFontSize(14);
  doc.text(`Basic Needs Scores`, 14, currentY);
  currentY += 6;

  if (user.basicneeds && typeof user.basicneeds === 'object') {
    const bn = user.basicneeds;
    const bnTable = [
      ['Survival', safe(bn.survival), `${safe(bn.survival_pct)}%`],
      ['Love', safe(bn.love), `${safe(bn.love_pct)}%`],
      ['Freedom', safe(bn.freedom), `${safe(bn.freedom_pct)}%`],
      ['Power', safe(bn.power), `${safe(bn.power_pct)}%`],
      ['Fun', safe(bn.fun), `${safe(bn.fun_pct)}%`],
    ];

    doc.autoTable({
      startY: currentY,
      head: [['Need', 'Score', 'Percent']],
      body: bnTable,
      margin: { left: 14, right: 14 },
    });

    currentY = doc.lastAutoTable.finalY + 10;
  } else {
    doc.setFontSize(12);
    doc.text('Basic Needs test not completed.', 14, currentY);
    currentY += 10;
  }

  // ------------------------------
  // FOOTER
  // ------------------------------

  doc.setFontSize(10);
  doc.setTextColor(120);
  doc.text(`Generated by MindMirror3D Admin Dashboard`, 14, 285);

  // Save file
  const filename = (user.full_name ?? user.email ?? 'user') + '_results.pdf';
  doc.save(filename);
};
